<!-- © Copyright 2024-2025, Pedro Almada
Licensed under the GPL-3.0-or-later

This file is part of the House buying calculator and is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
See the GNU General Public License for more details.

You should have received a copy of the GNU General Public License along with the house buying calculator software.
If not, see <https://www.gnu.org/licenses/>.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>House buying calculator</title>
</head>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@300..700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://moment.github.io/luxon/global/luxon.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@3.0.5/dist/js.cookie.min.js"></script>

<script src="js/update_currency.js"></script>
<script src="js/taxes.js"></script>
<script src="js/calculate.js"></script>
<script src="js/validate.js"></script>

<script>
    /**
     * Exports the input values provided by the user as URL parameters.
     *
     * @returns A URL string with the input values stored as URL parameters.
     */
    function exportAsURL() {
        let parameters = new URLSearchParams()

        let appendParameter = (id) =>  parameters.append(id, document.getElementById(id).value)

        appendParameter('house_price');
        appendParameter('savings');
        appendParameter('monthly_savings');
        appendParameter('mortgage_rate');
        appendParameter('savings_rate');
        appendParameter('house_price_inflation');
        appendParameter('min_deposit');
        appendParameter('rent');
        appendParameter('birth_date');
        appendParameter('retirement_age');
        appendParameter('max_mortgage_length');
        appendParameter('taxes');
        appendParameter('custom_tax_amount');

        return window.location.href.split("?")[0] + "?" + parameters.toString()
    }
</script>

<body>

<h1>House buying calculator</h1>

<form>
    <table>
    <tr>
        <th>Inputs</th>
        <th>Calculated values</th>
        <th>Chart</th>
    </tr>
    <tr>
        <td>
            <label for="currency">Currency (decorative only):</label>
            <input type="text" id="currency" name="currency" value="€" oninput="updateCurrency()">
            <br>
            <label for="house_price">House price:</label>
            <input type="number" id="house_price" name="house_price" min="1" step="5000" oninput="calculate()">
            <span class="currency-symbol">€</span>
            <br>
            <label for="savings">Savings:</label>
            <input type="number" id="savings" name="savings" min="0" step="1000" oninput="calculate()">
            <span class="currency-symbol">€</span>
            <br>
            <label for="monthly_savings">Monthly Savings:</label>
            <input type="number" id="monthly_savings" name="monthly_savings" min="0" step="100" oninput="calculate()">
            <span class="currency-symbol">€</span>
            <br>
            <label for="mortgage_rate">Mortgage interest rate:</label>
            <input type="number" id="mortgage_rate" name="mortgage_rate" min="0" step="0.1" oninput="calculate()">%
            <br>
            <label for="savings_rate">Savings Interest rate:</label>
            <input type="number" id="savings_rate" name="savings_rate" min="0" step="0.1" oninput="calculate()">%
            <br>
            <label for="house_price_inflation">House price inflation:</label>
            <input type="number" id="house_price_inflation" name="house_price_inflation" step="0.1" oninput="calculate()">%
            <br>
            <label for="min_deposit">Minimum deposit required by bank:</label>
            <input type="number" id="min_deposit" name="min_deposit" min="0" oninput="calculate()">%
            <br>
            <label for="rent">Current rent:</label>
            <input type="number" id="rent" name="rent" min="0" step="100" oninput="calculate()">
            <span class="currency-symbol">€</span>
            <br>
            <label for="birth_date">Birthdate:</label>
            <input type="date" id="birth_date" name="birth_date">
            <br>
            <label for="retirement_age">Retirement age:</label>
            <input type="number" id="retirement_age" name="retirement_age" min="16" oninput="calculate()">
            <br>
            <label for="max_mortgage_length">Max. mortgage length:</label>
            <input type="number" id="max_mortgage_length" min="1" name="max_mortgage_length" oninput="calculate()">
            <br>
            <label for="taxes">Tax region:</label>
            <select id="taxes" name="taxes" oninput="calculate()"></select>
            <br>
            <label for="custom_tax_amount">Custom tax amount: </label>
            <input type="number" id="custom_tax_amount" name="custom_tax_amount" min="0" step="1000" oninput="calculate()">
            <br>
        </td>
        <td class="calculated_values">
            <label for="date_retirement">Retirement date: </label><span id="date_retirement"></span>
            <br>
            <label for="months_retirement">Months until retirement: </label><span id="months_retirement"></span>
            <br>
            <label for="tax_amount">Tax for purchase: </label><span id="tax_amount"></span><span class="currency-symbol">€</span>
        </td>
        <td>
            <canvas id="totalCostChart" style="width: 100%; height: 100%;"></canvas>
        </td>
    </tr>
    <tr>
        <td id="scenario_1" class="scenario"></td>
        <td id="scenario_2" class="scenario"></td>
        <td id="scenario_3" class="scenario"></td>
    </tr>
    <tr>
        <td></td>
        <td>
            <input type="button"  id="export_button" class="export_button"
                   value="Export values as URL"
                   onclick="window.location.href = exportAsURL()">
        </td>
    </tr>
    </table>

    <div id="table">
        <table id="simulationsTable"></table>
    </div>

</form>

<div id="copyright_footer" class="copyright_footer">
    © Copyright 2024, Pedro Almada, licensed under the GPL-3.0-or-later.
    <br>
    For license details, visit <a href="https://www.gnu.org/licenses/gpl-3.0.txt" target="_blank">this page</a>.
</div>

</body>

<script>
    const COOKIE_API = Cookies.withAttributes({ path: '/', sameSite: 'Strict', secure: 'true', expires: 60  })
    const URL_PARAMS = new URLSearchParams(window.location.search);
    const TODAY = DateTime.now();
    // Default birthdate if someone has entered a birthdate in the future
    const DEFAULT_BIRTH_DATE = TODAY.minus({years: 30}).toISODate()

    let tax_selector = document.getElementById("taxes");

    let add_tax_selector_option = (value, text) => {
        let option = document.createElement('option');
        option.value = value;
        option.textContent = text;
        tax_selector.appendChild(option);
    }

    for (let region of SPANISH_REGIONS) {
        add_tax_selector_option('spain-' + region, 'Spain - ' + region);
    }

    add_tax_selector_option('custom', "Custom tax amount");

    /**
     * Sets up input parameters.
     *
     * First, reads the input parameters from the URL if set, or a cookie if it exists.
     * Else, it sets the input element's value to a default value.
     * It then validates the final value and adds 'oninput' function to validate values, update the cookie,
     * and finally trigger the simulation.
     *
     * @param {string} id The input element ID we're setting up
     * @param {any} default_value The default value starting for the parameter
     * @param {number} min For number inputs, the minimum value it should be set to.
     * @param {number} max For number inputs, the maximum value it should be set to.
     */
    let setParameter = (id, default_value = 0, min = 0, max = Number.MAX_SAFE_INTEGER) => {
        let value = default_value;

        if (URL_PARAMS.has(id)) {
            // The URL takes precedence
            value = URL_PARAMS.get(id);
        }
        else {
            // If no URL parameter was passed, we check if a cookie value exists
            let storedValue = COOKIE_API.get(id);
            if (storedValue !== undefined) {
                value = storedValue;
            }
        }

        validate(id, value);

        COOKIE_API.set(id, value);
        let element = document.getElementById(id);
        element.value = value;

        element.oninput = () => {
            validate(id, default_value, min, max);
            COOKIE_API.set(id, element.value)
            calculate();
        };
    }

    setParameter('house_price', 100_000);
    setParameter('savings', 1000);
    setParameter('monthly_savings', 100);
    setParameter('mortgage_rate', 3.5, 0, 100);
    setParameter('savings_rate', 3.5, 0, 100);
    setParameter('house_price_inflation', 3)
    setParameter('min_deposit', 10, 0, 100);
    setParameter('rent', 1000);
    setParameter('birth_date', DEFAULT_BIRTH_DATE);
    setParameter('retirement_age', 67, 18, 120);
    setParameter('max_mortgage_length', 35, 1);
    setParameter('taxes', 'custom');
    setParameter('custom_tax_amount', 0, 0);

    document.getElementById('birth_date').setAttribute('max', TODAY.toISODate());

    Chart.defaults.font.family = 'Quicksand';
    let chart = new Chart('totalCostChart', {
        type: "line",
        data: {
            labels: [1],
            datasets: [{
                data: [1],
                borderColor: "red",
                fill: false
            }]
        },
        options: {
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Total cost to buy the house at various points in the future.'
                }
            }
        }
    });

    calculate();

</script>

</html>